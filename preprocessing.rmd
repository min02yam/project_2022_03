---
title: "ahffk"
output: github_document
author: "KIM MINYOUNG"
---

# 0.환경설정
```{r 패키지}
rm(list=ls())
suppressPackageStartupMessages({
    require(googledrive)
    require(DataExplorer)
    require(dplyr)
    require(data.table)
    require(magrittr)
    require(imputeTS)
    #require(stringr)
    require(lubridate)
    #require(zoo)
})

drive_auth()
```

```{r 드라이브}
#drive_ls("2022_03/data",  pattern="train_input") %>% View(title="train")
train_in_id = drive_ls("2022_03/data",  pattern="train_input") $id
train_in_ls = drive_ls(path = as_id(train_in_id))
train_in_ls %<>% arrange(name)

final <- NULL
for (i in 1:nrow(train_in_ls)){
    drive_download(as_id(train_in_ls[i,]), overwrite = TRUE)
    file = assign(train_in_ls$name[i], fread(train_in_ls$name[i],  encoding="UTF-8" ))
    
    file$DAT =file$DAT+1
    file$case = rep(i, nrow(file))
    final = rbind(final, file)

    cat(i,"번째","완료","^^" ,"\n")
}

#final %>% head
```


```{r 결측치처리}
#plot_intro(final)
#final %>% summary
#final %>% head %>%  View()
final[내부온도관측치<4 | 내부온도관측치>40,내부온도관측치 := NA]
final[co2관측치>1200,co2관측치 :=NA]
final[시간당백색광량<0 | 시간당백색광량>120000,시간당백색광량 := NA]
final[일간누적백색광량<0 | 일간누적백색광량>2880000,일간누적백색광량 := NA]
final[시간당적색광량<0 | 시간당적색광량>120000,시간당적색광량 := NA]
final[일간누적적색광량<0 | 일간누적적색광량>2880000,일간누적적색광량 := NA]
final[시간당청색광량<0 | 시간당청색광량>120000,시간당청색광량 := NA]
final[일간누적청색광량<0 |  일간누적청색광량>2880000, 일간누적청색광량 := NA]
final[시간당총광량<0 | 시간당총광량>120000,시간당총광량 := NA]
final[일간누적총광량<0 |  일간누적총광량>2880000,  일간누적총광량 := NA]
```


```{r 결측치탐색}
colSums(is.na(final))
#plot_missing(final)
#final %>% head
#which(is.na(final))

final[is.na(내부온도관측치), .N, by=case]
final[is.na(co2관측치), .N, by=case]
final[is.na(시간당백색광량), .N, by=case]
final[is.na(시간당적색광량), .N, by=case]
final[is.na(시간당청색광량), .N, by=case]
final[is.na(시간당총광량), .N, by=case]

#ggplot_na_distribution(final$내부온도관측치)

```

내부온도 관측치 13
`case4` 1
`case8` 2
`case26` 10

co2관측치 102
`case1` 4
`case3` 96
`case4` 1
`case27` 1

시간당백색광량, 시간당적색광량,시간당청색광량,시간당총광량 1 -> `case6`에 1개로 모두 같음

```{r 시간 변수 조정}
#step1. 시간
final %>% mutate(new_obs_time = substr(obs_time,1,5),
    new_obs_time = parse_date_time(new_obs_time, orders="HM"),
    new_obs_time = case_when(
        grepl("[59]", new_obs_time) ~ new_obs_time + minutes(1),
        TRUE ~ new_obs_time),
    new_obs_time = hour(new_obs_time)
    ) %>% 
    select(!obs_time) -> tmp

# new_obs_time = as.POSIXlt(substr(new_obs_time,12,13),"%H")
tmp %>% str
#tmp %>% str
#tmp$new_obs_time %>% table
```

```{r 결측치대체}
#step1. ts 생성 (1시간 FREQUENCY)

?ts

ts = ts(tmp, frequency = 1, start=0, end=23) 

# 주기랑 end 계산하기 
ts %>% head(25)
tmp %>% filter(case==1) %>% View("case1")

```





train_out_id = drive_ls("2022_03/data",  pattern="train_target") $id
train_out_ls = drive_ls(path = as_id(train_out_id))
train_out_ls %<>% arrange(name)

drive_download(as_id(train_out_ls[1,]), overwrite = TRUE)
out_1 = assign(train_out_ls$name[1], fread(train_out_ls$name[1],  encoding="UTF-8" ))
out_1 %>% head
out_1 %>% tail
output <- NULL
for (i in 1:nrow(train_out_ls)){
    drive_download(as_id(train_out_ls[i,]), overwrite = TRUE)
    file = assign(train_out_ls$name[i], fread(train_out_ls$name[i],  encoding="UTF-8" ))
    file$case = rep(i, nrow(file))
    output = rbind(output, file)

    cat(i,"번째","완료" ,"\n")
}
